---
- name: Install security packages
  apt:
    name:
      - ufw
      - fail2ban
      - unattended-upgrades
      - logwatch
      - rkhunter
    state: present

- name: Configure UFW firewall
  block:
    - name: Reset UFW to defaults
      ufw:
        state: reset
        
    - name: Set UFW default policies
      ufw:
        direction: "{{ item.direction }}"
        policy: "{{ item.policy }}"
      with_items:
        - { direction: 'incoming', policy: 'deny' }
        - { direction: 'outgoing', policy: 'allow' }
        - { direction: 'routed', policy: 'deny' }
        
    - name: Allow SSH
      ufw:
        rule: allow
        port: '22'
        proto: tcp
        
    - name: Allow HTTP
      ufw:
        rule: allow
        port: '80'
        proto: tcp
        
    - name: Allow HTTPS
      ufw:
        rule: allow
        port: '443'
        proto: tcp
        
    - name: Allow NATS client port
      ufw:
        rule: allow
        port: '4222'
        proto: tcp
        
    - name: Allow NATS HTTP/monitoring + websockets port
      ufw:
        rule: allow
        port: '8222'
        proto: tcp
        
    - name: Allow Overwatch HTTP Service port
      ufw:
        rule: allow
        port: '8080'
        proto: tcp
        
    - name: Enable UFW
      ufw:
        state: enabled

- name: Configure fail2ban
  block:
    - name: Create fail2ban jail.local
      copy:
        content: |
          [DEFAULT]
          bantime = 3600
          findtime = 600
          maxretry = 5
          
          [sshd]
          enabled = true
          port = ssh
          filter = sshd
          logpath = /var/log/auth.log
          maxretry = 3
          
          [nginx-http-auth]
          enabled = true
          filter = nginx-http-auth
          logpath = /var/log/nginx/error.log
          
          [nginx-noscript]
          enabled = true
          filter = nginx-noscript
          logpath = /var/log/nginx/access.log
          maxretry = 6
        dest: /etc/fail2ban/jail.local
        backup: yes
      notify: restart fail2ban
      
    - name: Start and enable fail2ban
      systemd:
        name: fail2ban
        state: started
        enabled: yes

- name: Configure automatic security updates
  block:
    - name: Configure unattended-upgrades
      lineinfile:
        path: /etc/apt/apt.conf.d/50unattended-upgrades
        regexp: '^//\s*"${distro_id}:${distro_codename}-security";'
        line: '        "${distro_id}:${distro_codename}-security";'
        
    - name: Enable automatic security updates
      copy:
        content: |
          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Download-Upgradeable-Packages "1";
          APT::Periodic::AutocleanInterval "7";
          APT::Periodic::Unattended-Upgrade "1";
        dest: /etc/apt/apt.conf.d/20auto-upgrades

- name: Secure SSH configuration
  block:
    - name: Backup original sshd_config
      copy:
        src: /etc/ssh/sshd_config
        dest: /etc/ssh/sshd_config.backup
        remote_src: yes
        
    - name: Configure secure SSH settings
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      with_items:
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin yes' }
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
        - { regexp: '^#?Protocol', line: 'Protocol 2' }
        - { regexp: '^#?X11Forwarding', line: 'X11Forwarding no' }
        - { regexp: '^#?MaxAuthTries', line: 'MaxAuthTries 3' }
        - { regexp: '^#?ClientAliveInterval', line: 'ClientAliveInterval 300' }
        - { regexp: '^#?ClientAliveCountMax', line: 'ClientAliveCountMax 2' }
      notify: restart ssh